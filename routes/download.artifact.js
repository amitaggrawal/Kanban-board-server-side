const express = require('express');
const router = express.Router();
const path = require('path');

const Artifact = require('../src/models/artifact.model');

/** 
 * @amitaggrawal on 4th sep 19:  
 * param: artifactId :: here is Id generated by mongo when this document was inserted. 
 *                      Client will be sent this ID upon successful insertion of file.
 * 
 * NOTE: 
 *  1. If client passes an artifactID which does not exists it will not give err instead 
 *     will continue with data as null. Handled with null check.
 *  
 *  2. If client will not pass any param then also this will continue with data as null. Handled with null check.
 * 
 *  3. Error block is called when instead of ID client send something which is not parsable into ObjectId();
 *     Handled with null check.
 */

router.post('/', function (req, res, next) {
    const id = req.body.artifactId;
    console.log(id);
    if (id == null) {
        res.status(300).json({
            status: false,
            msg: 'Artifact ID is required as a parameter.'
        });
    } else {
        Artifact.findById(id, function (err, data) {
            if (err) {
                res.status(300).json({
                    status: false,
                    msg: 'Invalid artifact ID. Please check and try again.'
                })
            } else {
                if (data != null) {
                    filePath = path.join(__dirname + '/../uploads/' + data.artifactStoreFileName);
                    console.log(filePath);
                    res.status(200).sendFile(filePath);
                }
            }
        });
    }
});

module.exports = router;